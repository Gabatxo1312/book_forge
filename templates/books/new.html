{% extends "_base.html" %}

{% block title %}Add a book{% endblock %}

{% block body %}
<form action="/books" method="post">
  <div x-data="{
        query: '',
        items: [],
        open: false,
        loading: false,
        coverUrl: '',
        title: '',
        authors: '',
        async searchItems() {
            this.items = [];

            if (this.query.length === 0) {
                this.items = [];
                return;
            }
            
            this.loading = true;
            try {
                const response = await fetch(
                    `/books/search?query=${encodeURIComponent(this.query)}`
                );
                const result = await response.json();
                this.items = result.docs.slice(0, 30);
                console.log(this.items)
                this.open = true;
            } catch (error) {
                this.open = false;
                console.error('Error:', error);
            } finally {
                this.loading = false;
            }
        },
        selectItem(item) {
          this.title = item.title;
          this.authors = item.author_name.join(', ');
          this.coverUrl = `https://covers.openlibrary.org/b/OLID/${item.cover_edition_key}-L.jpg`;
          this.items = [];
          this.open = false;
        }
    }">
    <div class="mb-3">
      <label for="search" class="block mb-2 text-sm font-medium text-gray-900">Recherche sur OpenLibrary</label>
      <div class="relative">
        <input 
          type="text"
          name="search"
          id="search"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="Ex: Lord of the ring, Virginia Wolff" 
          x-model="query"
          @input.debounce.300ms="searchItems()"
        />

        <div x-show="open || loading" class="absolute top-11 w-full bg-white shadow-lg rounded-md border border-blue-950 h-[250px] overflow-hidden overflow-y-auto">
          <p x-show="loading">ðŸ”„ Recherche...</p>
        
          <ul x-show="open">
            <template x-for="item in items" :key="items.indexOf(item)">
              <li class="item px-4 py-2 flex gap-4" @click="selectItem(item)">
                <h3 x-text="item.title"></h3>
                <p class="mb-0 text-gray-500 italic" x-text="item.author_name.join(',')"></p>
              </li>
            </template>
          </ul>
          
          <p x-show="items.length === 0 && query && !loading && open">
            Aucun rÃ©sultat
          </p>

        </div>
      </div>
    </div>
     
    <div class="mb-3">
      <label for="title" class="block mb-2 text-sm font-medium text-gray-900">Title</label>
      <input 
        type="text"
        name="title"
        id="title"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
        placeholder="Ex: Lord of the ring" 
        required 
        x-model="title"
      />
    </div>

    <div class="mb-3">
      <label for="authors" class="block mb-2 text-sm font-medium text-gray-900">Author.s</label>
      <input 
        type="text"
        name="authors"
        id="authors"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
        placeholder="Ex: Pierre Kropotkine" 
        required 
        x-model="authors"
      />
    </div>

    <div class="mb-3">
      <label for="description" class="block mb-2 text-sm font-medium text-gray-900">description</label>
      <textarea name="description" id="description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></textarea>
    </div>

    <div class="mb-3">
      <label for="cover_url" class="block mb-2 text-sm font-medium text-gray-900">Cover Url</label>
      <input type="text" name="cover_url" id="cover_url" value="" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" x-model="coverUrl" />
    </div>

    <div class="mb-3">
      <label for="open_library_link" class="block mb-2 text-sm font-medium text-gray-900">Open Library Url</label>
      <input type="text" name="open_library_link" id="open_library_link" value="" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" />
    </div>

    <div class="mb-3">
      <label for="owner_id" class="block mb-2 text-sm font-medium text-gray-900">Select an owner</label>
      <select id="owner_id" name="owner_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
        {% for user in users %}
          <option value="{{ user.id }}">{{ user.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="current_holder_id" class="block mb-2 text-sm font-medium text-gray-900">Selectionner le detenteur actuel</label>
      <select id="current_holder_id" name="current_holder_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
        <option value=""></option>
        {% for user in users %}
          <option value="{{ user.id }}">{{ user.name }}</option>
        {% endfor %}
      </select>
    </div>

  </div>

  <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Add</button>
</form>
{% endblock %}
